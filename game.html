<!DOCTYPE html>
<html>

<head>
<script src="https://aframe.io/releases/0.3.0/aframe.min.js"></script>
<script src="https://sdk.altvr.com/libs/altspace.js/2.4.0/altspace.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nunjucks/3.0.0/nunjucks.min.js"></script>
<script src="https://rawgit.com/ngokevin/kframe/a1df8fc01514e509ba6d39c964254a1f1043b12b/dist/kframe.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/4.9.0/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyCvKQCyURJiH13dXDl_f6kB_deZ67QmbgQ",
    authDomain: "vrmonopoly.firebaseapp.com",
    databaseURL: "https://vrmonopoly.firebaseio.com",
    projectId: "vrmonopoly",
    storageBucket: "vrmonopoly.appspot.com",
    messagingSenderId: "831868478183"
  };
  firebase.initializeApp(config);
</script>

</head>

<body>

<!-- set up the scene -->
<a-scene altspace="fullspace: true" sync-system="author: greeny3ny; app: monopoly">
 
    <!-- add a view camera (2d only) -->
    <!--<a-text value="Hello, World!"></a-text>-->

    <a-assets>
		<img id="board" src="https://greeny3ny.github.io/VRmonopoly/ALTOPOLY.png"/>
  	</a-assets>

	<a-entity position='-8 16 -15' rotation='0 0 0' n-text='text: Craigs Monopoly! ;'></a-entity>
	<a-entity id="players" position='8 16 -15' rotation='0 0 0' n-text='text: Players :  ;' ></a-entity>
	<a-entity id="version" position='-8 15 -15' rotation='0 0 0' n-text='text: Version :  ;' ></a-entity>

    <a-entity geometry="primitive: box" material="shader: flat; src: #board" position = '0 0 0' scale="20 0 20"></a-entity>
	
	<a-box id="tile0" n-mesh-collider="type:hologram" color="white" position="-8.75, 1, 8.75" rotation="0 0 0" scale="3 3 3" opacity="0.5"  altspace-cursor-collider="enabled: false"></a-box> <!-- home collider-->
	
	<a-sky color="black" radius="200"></a-sky>
	
	<a-entity id="board1" position='-9 12 -15' rotation='0 0 0' n-text='text: ---;' ></a-entity>
	<a-entity id="board2" position='-9 11 -15' rotation='0 0 0' n-text='text: ---;' ></a-entity>
	<a-entity id="board3" position='-9 10 -15' rotation='0 0 0' n-text='text: ---;' ></a-entity>
	<a-entity id="board4" position='-9 9 -15' rotation='0 0 0' n-text='text: ---;' ></a-entity>
	<a-entity id="board5" position='-9 8 -15' rotation='0 0 0' n-text='text: ---;' ></a-entity>
	<a-entity id="board6" position='-9 7 -15' rotation='0 0 0' n-text='text: ---;' ></a-entity>
	<a-entity id="board7" position='-9 6 -15' rotation='0 0 0' n-text='text: ---;' ></a-entity>
	<a-entity id="board8" position='-9 5 -15' rotation='0 0 0' n-text='text: ---;' ></a-entity>
	
	<a-entity id="money1" position='0 12 -15' rotation='0 0 0' n-text='text: ---;' ></a-entity>
	<a-entity id="money2" position='0 11 -15' rotation='0 0 0' n-text='text: ---;' ></a-entity>
	<a-entity id="money3" position='0 10 -15' rotation='0 0 0' n-text='text: ---;' ></a-entity>
	<a-entity id="money4" position='0 9 -15' rotation='0 0 0' n-text='text: ---;' ></a-entity>
	<a-entity id="money5" position='0 8 -15' rotation='0 0 0' n-text='text: ---;' ></a-entity>
	<a-entity id="money6" position='0 7 -15' rotation='0 0 0' n-text='text: ---;' ></a-entity>
	<a-entity id="money7" position='0 6 -15' rotation='0 0 0' n-text='text: ---;' ></a-entity>
	<a-entity id="money8" position='0 5 -15' rotation='0 0 0' n-text='text: ---;' ></a-entity>

	<!--
	<a-box color="black" position="-10, 0, -4.8" scale="0.5, 0.5, 0.5"></a-box>
	<a-box color="red" position="-10, 0, -4.3" scale="0.5, 0.5, 0.5"></a-box>
	<a-box color="green" position="-10, 0, -5.3" scale="0.5, 0.5, 0.5"></a-box>
	<!--<a-box depth="100" height="0.1" width="100" position='0 360 0'><a-box>A
	
	
--> 
</a-scene>
 
</body>

<script>
var version = "0.0.1"
console.log("Version : " + version);
document.querySelector('#version').setAttribute('n-text','text: Version : ' + version);
var fbGameRef = new Firebase("https://vrmonopoly.firebaseio.com/");
var sim = new altspace.utilities.Simulation();

//--- box stuff ---
var redMat = new THREE.MeshBasicMaterial( { color: 0xff0000 } );
var pinkMat = new THREE.MeshBasicMaterial( { color: 0xff00ff } );
var greenMat = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
var blueMat = new THREE.MeshBasicMaterial( { color: 0x0000ff } );
//-
var boxGeo = new THREE.BoxGeometry(1, 1, 1);
//-
var joinBox = new THREE.Mesh(boxGeo, redMat); 
var startBox = new THREE.Mesh(boxGeo, pinkMat);
var resetBox = new THREE.Mesh(boxGeo, greenMat);
var rollDiceBox = new THREE.Mesh(boxGeo, greenMat);
var endTurnBox = new THREE.Mesh(boxGeo, blueMat);
//--- 

//---- LOCAL VARIABLES ----
var joined = false; //have I joined the game?
var postId;

//----                 ----

//---- SYNCED VARIABLES ----
var players = [];
var data=[]; //what players are in the game / their data
//----                  ----

getUser();

function main(){
	console.log("main");

	resetVars();
	
	sim.scene.add(joinBox);

}

function getUser(){
	
	altspace.getUser().then(function(user1){
		console.log(user1);
		user = user1.displayName;
		console.log(user);
		//sets timeout to deal with latency issues - kinda works
		//setTimeout(addToSession, 2000); 
	}).then(main());
	
}

//initialise variables
function resetVars(){
	
}

//update database
var counter=0;

function updateFirebase(){
	
	/*
	if (postId == null){
		postId = fbGameRef.child("players").push().key(); //get the post id
		console.log(postId);
	}
	
	fbGameRef.child("players/"+postId).update({data:data});
	*/
	
	players[counter] = data;
	counter ++;
	
	fbGameRef.child("players").update({players:players});
	
}
//reads users in session

function readFirebase(){
	//child_changed, child_added
	//console.log("read");

	fbGameRef.child("players").on("value", function(snapshot){
		console.log(snapshot.val());
	});
	
	
	fbGameRef.child("players").on("child_changed", function(snapshot){
		console.log("read" + snapshot);
	}); 
}

//keep code clean
function drawText(){
	//only draw money if gamestarted else error
	if (gameStart == true){
		/*
		document.querySelector('#board1').setAttribute('n-text','text:' + players[0]);
		document.querySelector('#board2').setAttribute('n-text','text:' + players[1]);
		document.querySelector('#board3').setAttribute('n-text','text:' + players[2]);
		document.querySelector('#board4').setAttribute('n-text','text:' + players[3]);
		document.querySelector('#board5').setAttribute('n-text','text:' + players[4]);
		document.querySelector('#board6').setAttribute('n-text','text:' + players[5]);
		document.querySelector('#board7').setAttribute('n-text','text:' + players[6]);
		document.querySelector('#board8').setAttribute('n-text','text:' + players[7]);
	
		document.querySelector('#money1').setAttribute('n-text','text:' + playerMoney[0]);
		document.querySelector('#money2').setAttribute('n-text','text:' + playerMoney[1]);
		document.querySelector('#money3').setAttribute('n-text','text:' + playerMoney[2]);
		document.querySelector('#money4').setAttribute('n-text','text:' + playerMoney[3]);
		document.querySelector('#money5').setAttribute('n-text','text:' + playerMoney[4]);
		document.querySelector('#money6').setAttribute('n-text','text:' + playerMoney[5]);
		document.querySelector('#money7').setAttribute('n-text','text:' + playerMoney[6]);
		document.querySelector('#money8').setAttribute('n-text','text:' + playerMoney[7]);
		*/
	}else{
	
		document.querySelector('#board1').setAttribute('n-text','text:---');
		document.querySelector('#board2').setAttribute('n-text','text:---');
		document.querySelector('#board3').setAttribute('n-text','text:---');
		document.querySelector('#board4').setAttribute('n-text','text:---');
		document.querySelector('#board5').setAttribute('n-text','text:---');
		document.querySelector('#board6').setAttribute('n-text','text:---');
		document.querySelector('#board7').setAttribute('n-text','text:---');
		document.querySelector('#board8').setAttribute('n-text','text:---');
	
		document.querySelector('#money1').setAttribute('n-text','text:---');
		document.querySelector('#money2').setAttribute('n-text','text:---');
		document.querySelector('#money3').setAttribute('n-text','text:---');
		document.querySelector('#money4').setAttribute('n-text','text:---');
		document.querySelector('#money5').setAttribute('n-text','text:---');
		document.querySelector('#money6').setAttribute('n-text','text:---');
		document.querySelector('#money7').setAttribute('n-text','text:---');
		document.querySelector('#money8').setAttribute('n-text','text:---');
	
	}
	
}

joinBox.addEventListener('cursordown', function(){
	
	joined = true;
	console.log("join click " + joined);
	console.log("Player " + user + " joined");
	data[0] = user; //name
	data[1] = 1500; //money
	data[2] = 0; //position
	data[3] = []; //places owned
	data[4] = []; //houses owned (only if places owned)
	
	updateFirebase();
	readFirebase();
	
});

resetBox.addEventListener('cursordown', function(){
	
	resetVars();
	
	updateFirebase(); //update firebase
	
	console.log("game reset");
	
});

startBox.addEventListener('cursordown', function(){
	console.log("game start");
	
});
</script>
</html>
