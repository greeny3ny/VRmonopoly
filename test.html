<!DOCTYPE html>
<html>

<head>
<script src="https://aframe.io/releases/0.3.0/aframe.min.js"></script>
<!--<script src="https://cdn.rawgit.com/AltspaceVR/AltspaceSDK/v2.0.2/dist/altspace.min.js"></script>-->
<script src="../../dist/altspace.js"></script>
<script src="https://sdk.altvr.com/libs/altspace.js/2.4.0/altspace.min.js"></script>
<script src="js/three.js"></script>

<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyAPChB8eI_3xS0Sm8UW1IWcyR-_aE5YJyo",
    authDomain: "greeny-masterdatabase-altspace.firebaseapp.com",
    databaseURL: "https://greeny-masterdatabase-altspace.firebaseio.com",
    projectId: "greeny-masterdatabase-altspace",
    storageBucket: "greeny-masterdatabase-altspace.appspot.com",
    messagingSenderId: "667469072790"
  };
  firebase.initializeApp(config);
</script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyCvKQCyURJiH13dXDl_f6kB_deZ67QmbgQ",
    authDomain: "vrmonopoly.firebaseapp.com",
    databaseURL: "https://vrmonopoly.firebaseio.com",
    projectId: "vrmonopoly",
    storageBucket: "vrmonopoly.appspot.com",
    messagingSenderId: "831868478183"
  };
  firebase.initializeApp(config);
</script>
</head>

<body>

<!-- set up the scene -->
<a-scene altspace="fullspace: true" sync-system="author: greeny3ny; app: monopoly">
 
    <!-- add a view camera (2d only) -->
    <!--<a-text value="Hello, World!"></a-text>-->

    <a-assets>
		<img id="board" src="https://cdn.rawgit.com/greeny3ny/VRmonopoly/e768e8da/ALTOPOLY.png"/>
  	</a-assets>

	<a-entity position='-8 16 -15' rotation='0 0 0' n-text='text: Craigs Monopoly! ;'></a-entity>
	<a-entity id="players" position='8 16 -15' rotation='0 0 0' n-text='text: Players :  ;' ></a-entity>
	<a-entity id="version" position='-8 15 -15' rotation='0 0 0' n-text='text: Version :  ;' ></a-entity>

    <a-entity geometry="primitive: box" material="shader: flat; src: #board" position = '0 0 0' scale="20 0 20"></a-entity>
	
	<a-box id="tile0" collision="box_id:0;"n-mesh-collider="type:hologram" color="white" position="-8.75, 1, 8.75" rotation="0 0 0" scale="3 3 3" opacity="0.5"  altspace-cursor-collider="enabled: false"></a-box> <!-- home collider-->
	
	<a-sky color="black" radius="200"></a-sky>
	
	<a-entity id="board1" position='-9 12 -15' rotation='0 0 0' n-text='text: Version :  ;' ></a-entity>
	<a-entity id="board2" position='-9 11 -15' rotation='0 0 0' n-text='text: Version :  ;' ></a-entity>
	<a-entity id="board3" position='-9 10 -15' rotation='0 0 0' n-text='text: Version :  ;' ></a-entity>
	<a-entity id="board4" position='-9 9 -15' rotation='0 0 0' n-text='text: Version :  ;' ></a-entity>
	<a-entity id="board5" position='-9 8 -15' rotation='0 0 0' n-text='text: Version :  ;' ></a-entity>
	<a-entity id="board6" position='-9 7 -15' rotation='0 0 0' n-text='text: Version :  ;' ></a-entity>
	<a-entity id="board7" position='-9 6 -15' rotation='0 0 0' n-text='text: Version :  ;' ></a-entity>
	<a-entity id="board8" position='-9 5 -15' rotation='0 0 0' n-text='text: Version :  ;' ></a-entity>
	
	<a-entity id="money1" position='0 12 -15' rotation='0 0 0' n-text='text: Version :  ;' ></a-entity>
	<a-entity id="money2" position='0 11 -15' rotation='0 0 0' n-text='text: Version :  ;' ></a-entity>
	<a-entity id="money3" position='0 10 -15' rotation='0 0 0' n-text='text: Version :  ;' ></a-entity>
	<a-entity id="money4" position='0 9 -15' rotation='0 0 0' n-text='text: Version :  ;' ></a-entity>
	<a-entity id="money5" position='0 8 -15' rotation='0 0 0' n-text='text: Version :  ;' ></a-entity>
	<a-entity id="money6" position='0 7 -15' rotation='0 0 0' n-text='text: Version :  ;' ></a-entity>
	<a-entity id="money7" position='0 6 -15' rotation='0 0 0' n-text='text: Version :  ;' ></a-entity>
	<a-entity id="money8" position='0 5 -15' rotation='0 0 0' n-text='text: Version :  ;' ></a-entity>

	
	<!--<a-box color="black" position="-6.4, 0, 9" scale="0.5, 0.5, 0.5"></a-box>w
	<!--<a-box depth="100" height="0.1" width="100" position='0 360 0'><a-box>A
	
	
--> 
</a-scene>
 
</body>

<script>
var version = "0.4.4.1"
console.log("Version :" + version);
document.querySelector('#version').setAttribute('n-text','text: Version : ' + version);

var fbMasterRef = new Firebase("https://greeny-masterdatabase-altspace.firebaseio.com/");
var fbGameRef = new Firebase("https://vrmonopoly.firebaseio.com/");

var username;
var userID;
var moderator;
var displayname;

//update info in master database
altspace.getUser().then(function(userInfo) {
	var dataRequest = (THREE.FileLoader ? new THREE.FileLoader() : new THREE.XHRLoader());
	dataRequest.setWithCredentials(true);
	dataRequest.load('https://account.altvr.com/api/v1/users/' + userInfo.userId, onLoaded, undefined, undefined);
	function onLoaded(obj) {
		console.log('JSON thing:');
		console.log(JSON.parse(obj));
		username = JSON.parse(obj).users[0].username;
		userID = JSON.parse(obj).users[0].user_id;
		moderator = JSON.parse(obj).users[0].admin;
		displayname = JSON.parse(obj).users[0].display_name;

		console.log(username + " " + userID + " " + moderator + " " + displayname);

		
		
		fbMasterRef.child("users").once('value', function (snapshot) {
			console.log('Snapshot function worked!');
			console.log(snapshot.child(username).child('Username').val());

			var usernameSnapshot = snapshot.child(username).child('Username').val();

			if (snapshot.exists() && usernameSnapshot == username) {
				console.log('Snapshot exists!');

			} else if (snapshot.exists() && usernameSnapshot != username && usernameSnapshot != null) {
				console.log('Snapshot exists, but user has changed their username.');
				fbMasterRef.child("users").child(username).child('Username').update(username);

			} else {
				console.log('Snapshot does not exist; creating one...');
				console.log('Snapshot will be: ' + username + ', ' + userID + ', ' + moderator + '.');
				fbMasterRef.child("users").child(username).set({'Moderator': moderator, 'User ID': userID, 'Username': username, 'Display Name': displayname}, function () {
					console.log('Snapshot created!');
				});
			}

		});

		
		
		altspace.getDocument().then(function (document) { document.position.set(100, 100, 100); document.rotation.set(0, 90, 0);});
		console.log("loaded");
		
		//main();
		
		
	}
}); 

//---------------------------------------------------------------
//---------------------------------------------------------------
//---------------------------------------------------------------
//---------------------------------------------------------------
//---------------------------------------------------------------
//---------------------------------------------------------------

//--- synchronisation
setTimeout(main, 2000); //waits for user data before starting

//add user to database
//add heartbeat to database
//check other heartbeats
//do database stuff re heatbeats

var sim = new altspace.utilities.Simulation(); //simulation

var gameStart; //boolean declaring if game is started or not

var joined; //local 

var loaded = false;

var players;
var playerTurn; //what players turn is it

var playerPos; //0 = go, array storing all players locations
var player_element; //element local player in array is
var playerMoney; //array holding all money for players

function main(){

	console.log("main");
	
	initVars();
	initialiseBoxes();
	
	setInterval(tick, 1000); //start ticker
	//setInterval(checkHeartbeats, 5000); //checks heartbeats every 5 seconds
	

}

//initialise variables
function initVars(){
	gameStart = false;
	
	joined = false;
	
	players = [];
	
	playerTurn = 0;
	playerPos = [];	
	playerMoney = [];
}

//update database
function updateFirebase(){
	fbGameRef.update({
		players: players,
		turn: playerTurn,
		position: playerPos,
		gameStart: gameStart,
		money: playerMoney
	});
	//console.log("database updated!");
}

//reads users in session
function readFirebaseUsers(){

	fbGameRef.child("inSession").on("value", function(snapshot) {
		inSession = snapshot.val();
	});

}

//reads users who are playing
function readFirebasePlayers(){

	fbGameRef.child("players").on("value", function(snapshot){
		players = snapshot.val();
	});

}

function readFirebaseTurn(){
	fbGameRef.child("turn").on("value", function(snapshot){
		playerTurn = snapshot.val();
	});
}

function readFirebasePos(){

	fbGameRef.child("position").on("value", function(snapshot){
		playerPos = snapshot.val();
	});

}

function readFirebaseStart(){
	fbGameRef.child("gameStart").on("value", function(snapshot){
		gameStart = snapshot.val();
	});
}

function readFirebaseMoney(){

	fbGameRef.child("money").on("value", function(snapshot){
		playerMoney = snapshot.val();
	});

}


var temp = false;
var temp_start = false;
var rolled = false; //is dice been rolled?
//tick function
function tick(){

	readFirebasePlayers(); //check if players is being updated
	readFirebaseStart();
	readFirebaseTurn();
	//readFirebaseMoney();
	
if (gameStart == true){
	//console.log(playerTurn + " | " + players[playerTurn]);
	
	readFirebaseMoney();
	
	//set up start
	if (temp_start == false) {
		playerPos = []; //initialise array
		//playerMoney = []; //init array
		//--------------
		
		sim.scene.remove(startBox); //throws error, but works
		temp_start = true;
	}
	
	if (players[playerTurn] == displayname){
		if (temp == false){
			console.log("its your turn!");
			sim.scene.add(rollDiceBox);
			temp = true;
		} 
	} 
	

	for (var i = 0; i < players.length; i++){
		setPositions(i);
		//console.log("test1");
	}

	
	
	
	
	
	
	
	
} else {

 //basically reset stuff
	
	if (joined == false){
		sim.scene.remove(startBox); //remove startbox
	}
	sim.scene.remove(rollDiceBox);
	
	
	if (players == null){
		//console.log("test");
		joined = false;
	}
	
	//console.log("game reset");

	temp = false;
	rolled = false;
	
	temp_start = false;
	
	


} //end gamestart if



	//change n-text
	document.querySelector('#players').setAttribute('n-text','text: Players : ' + players);
	

	//keeps leaderboards updated
	drawText();
	

}//end tick function


//keep code clean
function drawText(){

	//only draw money if gamestarted else error
	if (gameStart == true){
	
		document.querySelector('#board1').setAttribute('n-text','text:' + players[0]);
		document.querySelector('#board2').setAttribute('n-text','text:' + players[1]);
		document.querySelector('#board3').setAttribute('n-text','text:' + players[2]);
		document.querySelector('#board4').setAttribute('n-text','text:' + players[3]);
		document.querySelector('#board5').setAttribute('n-text','text:' + players[4]);
		document.querySelector('#board6').setAttribute('n-text','text:' + players[5]);
		document.querySelector('#board7').setAttribute('n-text','text:' + players[6]);
		document.querySelector('#board8').setAttribute('n-text','text:' + players[7]);
	
		document.querySelector('#money1').setAttribute('n-text','text:' + playerMoney[0]);
		document.querySelector('#money2').setAttribute('n-text','text:' + playerMoney[1]);
		document.querySelector('#money3').setAttribute('n-text','text:' + playerMoney[2]);
		document.querySelector('#money4').setAttribute('n-text','text:' + playerMoney[3]);
		document.querySelector('#money5').setAttribute('n-text','text:' + playerMoney[4]);
		document.querySelector('#money6').setAttribute('n-text','text:' + playerMoney[5]);
		document.querySelector('#money7').setAttribute('n-text','text:' + playerMoney[6]);
		document.querySelector('#money8').setAttribute('n-text','text:' + playerMoney[7]);
	
	}else{
	
		document.querySelector('#board1').setAttribute('n-text','text:---');
		document.querySelector('#board2').setAttribute('n-text','text:---');
		document.querySelector('#board3').setAttribute('n-text','text:---');
		document.querySelector('#board4').setAttribute('n-text','text:---');
		document.querySelector('#board5').setAttribute('n-text','text:---');
		document.querySelector('#board6').setAttribute('n-text','text:---');
		document.querySelector('#board7').setAttribute('n-text','text:---');
		document.querySelector('#board8').setAttribute('n-text','text:---');
	
		document.querySelector('#money1').setAttribute('n-text','text:---');
		document.querySelector('#money2').setAttribute('n-text','text:---');
		document.querySelector('#money3').setAttribute('n-text','text:---');
		document.querySelector('#money4').setAttribute('n-text','text:---');
		document.querySelector('#money5').setAttribute('n-text','text:---');
		document.querySelector('#money6').setAttribute('n-text','text:---');
		document.querySelector('#money7').setAttribute('n-text','text:---');
		document.querySelector('#money8').setAttribute('n-text','text:---');
	
	}
	
}



function initialiseBoxes(){

	//max 8 players in a game
	for (var i = 0; i < 8; i++){
		playerIcons[i] = new THREE.Mesh(boxGeo, pinkMat);			
		voteKickBox[i] = new THREE.Mesh(boxGeo, greenMat);
			
		playerIcons[i].position.set(-11, i, 11); //testing
		voteKickBox[i].position.set(12, 2*i, -6); //testing 2
		
		playerIcons[i].scale.set(0.5, 1, 0.5);

		sim.scene.add(playerIcons[i]);
		sim.scene.add(voteKickBox[i]);
	}
	
	
	

}

//move boxes to position and carries out specific task based on place
//brunt of the code goes here
function setPositions(playerNo){
	
	//console.log("positions set");
	
	if (playerPos[playerNo] >= 40){
		playerPos[playerNo] -= 40; //back at go (0)
		playerMoney[playerNo] += 200; //collect 200
	}

	switch (playerPos[playerNo]){
	case 0:
	//CAMPFIRE (GO)
	playerIcons[playerNo].position.set(-9, 0, 8.5); 
	
	break;
	case 1:
	//VR MEDITATION (BROWN-1)
	playerIcons[playerNo].position.set(-9, 0, 6.5); 
	break;
	case 2:
	//CHEST
	playerIcons[playerNo].position.set(-9, 0, 4.85); 
	break;
	case 3:
	//VR YOGA (BROWN-2)
	playerIcons[playerNo].position.set(-9, 0, 3.35); 
	break;
	case 4:
	//LISA TAX -NAME TBC- (TAX-200)
	playerIcons[playerNo].position.set(-9, 0, 1.7); 
	playerMoney[playerNo] -= 200; //income tax
	break;
	case 5:
	//CAMPFIRE PORTAL (RAIL-1)
	playerIcons[playerNo].position.set(-9, 0, 0.1); 
	break;
	case 6:
	//DISC GOLF (LBLUE-1)
	playerIcons[playerNo].position.set(-9, 0, -1.55); 
	break;
	case 7:
	//CHANCE
	playerIcons[playerNo].position.set(-9, 0, -3.2); 
	break;
	case 8:
	//JUNGLE MAZE (LBLUE-2)
	playerIcons[playerNo].position.set(-9, 0, -4.8); 
	break;
	case 9:
	//MEDIEVAL TAVERN (LBLUE-3)
	playerIcons[playerNo].position.set(-9, 0, -6.4); 
	break;
	case 10:
	//SUSPENSION (JAIL)
	//JAILED
	//playerIcons[playerNo].position.set(-8.25, 0, -8.25); 
	//JUST VISITING
	playerIcons[playerNo].position.set(-9.5, 0, -9.5); 
	break;
	case 11:
	//360 THEATER (PINK-1)
	playerIcons[playerNo].position.set(-6.5, 0, -9); 
	break;
	case 12:
	//-UNNAMED- (UTIL-1)
	playerIcons[playerNo].position.set(-4.85, 0, -9); 
	break;
	case 13:
	//RAINBOW ROOM (PINK-2)
	playerIcons[playerNo].position.set(-3.35, 0, -9); 
	break;
	case 14:
	//WINTER WONDERLAND (PINK-3)
	playerIcons[playerNo].position.set(-1.7, 0, -9); 
	break;
	case 15:
	//JUNGLE MAZE TELEPORT (RAIL-2)
	playerIcons[playerNo].position.set(-0.1, 0, -9); 
	break;
	case 16:
	//BOSS MONSTER (ORANGE-1)
	playerIcons[playerNo].position.set(1.55, 0, -9); 
	break;
	case 17:
	//CHEST
	playerIcons[playerNo].position.set(3.2, 0, -9); 
	break;
	case 18:
	//HOLOGRAMGS(ORANGE-2)
	playerIcons[playerNo].position.set(4.8, 0, -9); 
	break;
	case 19:
	//LOVE LETTER (ORANGE-3)
	playerIcons[playerNo].position.set(6.4, 0, -9); 
	break;
	case 20:
	//COMMUNITY CORNER(FREE PARKING)
	playerIcons[playerNo].position.set(9.5, 0, -9.5); 
	break;
	
	case 21:
	//SCULPT TOGETHER (RED-1)
	playerIcons[playerNo].position.set(9, 0, -6.5); 
	break;
	case 22:
	//CHANCE
	playerIcons[playerNo].position.set(9, 0, -4.85); 
	break;
	case 23:
	//PAINT STUDIO (RED-2)
	playerIcons[playerNo].position.set(9, 0, -3.35); 
	break;
	case 24:
	//SDK (RED-3)
	playerIcons[playerNo].position.set(9, 0, -1.7); 
	break;
	case 25:
	//DISC GOLD TELEPORT (RAIL-3)
	playerIcons[playerNo].position.set(9, 0, -0.1); 
	break;
	case 26:
	//VIDEO JUKEBOX (YELLOW-1)
	playerIcons[playerNo].position.set(9, 0, 1.55); 
	break;
	case 27:
	//NIGHT HOUSE PARTY (YELLOW-2)
	playerIcons[playerNo].position.set(9, 0, 3.2); 
	break;
	case 28:
	//-UNNAMED- (UTIL-2)
	playerIcons[playerNo].position.set(9, 0, 4.8); 
	break;
	case 29:
	//HOUSE PARTY (YELLOW-3)
	playerIcons[playerNo].position.set(9, 0, 6.4); 
	break;
	case 30:
	//GO TO SUSPENSION (GO TO JAIL)
	playerIcons[playerNo].position.set(-8.25, 0, -8.25); 
	
	//change this to jail and add popup?
	break;
	case 31:
	//360 THEATER (PINK-1)
	playerIcons[playerNo].position.set(6.5, 0, 9); 
	break;
	
	case 32:
	//-UNNAMED- (UTIL-1)
	playerIcons[playerNo].position.set(4.85, 0, 9); 
	break;
	case 33:
	//RAINBOW ROOM (PINK-2)
	playerIcons[playerNo].position.set(3.35, 0, 9); 
	break;
	case 34:
	//WINTER WONDERLAND (PINK-3)
	playerIcons[playerNo].position.set(1.7, 0, 9); 
	break;
	case 35:
	//JUNGLE MAZE TELEPORT (RAIL-2)
	playerIcons[playerNo].position.set(0.1, 0, 9); 
	break;
	case 36:
	//BOSS MONSTER (ORANGE-1)
	playerIcons[playerNo].position.set(-1.55, 0, 9); 
	break;
	case 37:
	//CHEST
	playerIcons[playerNo].position.set(-3.2, 0, 9); 
	break;
	case 38:
	//HOLOGRAMGS(ORANGE-2)
	playerIcons[playerNo].position.set(-4.8, 0, 9); 
	break;
	case 39:
	//LOVE LETTER (ORANGE-3)
	playerIcons[playerNo].position.set(-6.4, 0, 9); 
	break;	
	
	}//end switch

}

//base collision aframe component code
AFRAME.registerComponent('collision',
                         {
  schema:  //does stuff
  { 
    jointCubeSize: {
      type: 'float',
      default: 0.275
    },
	box_id:
	{
		type: 'int'
	}
  },
  init: function ()
  {
    var self = this;
    var object = self.el.object3D;
	
    object.addBehavior(new altspace.utilities.behaviors.JointCollisionEvents
                       ({
      joints: [['Head', 'Center', 0]], jointCubeSize: self.data.jointCubeSize
    }));
	
	//joints enter
    object.addEventListener('jointcollisionenter', handleJoin);		
    function handleJoin(event)
    {
		console.log(self.data.box_id);
    }// end function handle join
	
	//joint collision leave
    object.addEventListener('jointcollisionleave', handleLeave);
    function handleLeave(event)
    {
		
    }//end function handle leave
  }
}); //end base collision
 
var redMat = new THREE.MeshBasicMaterial( { color: 0xff0000 } );
var pinkMat = new THREE.MeshBasicMaterial( { color: 0xff00ff } );
var greenMat = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );

var boxGeo = new THREE.BoxGeometry(1, 1, 1);

var joinBox = new THREE.Mesh(boxGeo, redMat); 
var startBox = new THREE.Mesh(boxGeo, pinkMat);
var resetBox = new THREE.Mesh(boxGeo, greenMat);
var rollDiceBox = new THREE.Mesh(boxGeo, greenMat);

var playerIcons = [];
var voteKickBox = [];

var counter = 0;

joinBox.position.set(0, 2, 0);
startBox.position.set(0,2,1);
resetBox.position.set(10, 0, 10);
rollDiceBox.position.set(0,2,-1);

sim.scene.add(joinBox);
sim.scene.add(resetBox);
//sim.scene.add(rollDiceBox);

joinBox.addEventListener('cursordown', function(){
	console.log("join click | " + joined);
	if (joined == false && gameStart == false){
		
		//players already being read every second
		//add to database
		console.log(players);
		
		//issue here
		if (players == null){
			players = []; //sets up array again
			players[0] = displayname;
			player_element = 0;
		} else {
			players[players.length] = displayname;
			player_element = players.length;
		}
		
		sim.scene.add(startBox); //startbox only appears for person who joins game
		
		playerIcons[player_element].position.set(-9, 0, 8.5); 
		
		
		joined = true;
		console.log(displayname + " joined!");
		updateFirebase(); //updates firebase with new info
	}
	
});

resetBox.addEventListener('cursordown', function(){
	
	players = []; //reset players
	playerTurn = 0;
	playerPos = [];
	gameStart = false;
	playerMoney = [];
	updateFirebase(); //update firebase
	
});

rollDiceBox.addEventListener('cursordown', function(){
	
	var test = Math.floor((Math.random() * 12) + 1);
	console.log(test);
	
	rolled = true;
	
	readFirebasePos();
	playerPos[playerTurn] += test;
	console.log("Player moves to pos:" + playerPos);
	
	setPositions(playerTurn); //works kinda?
	
	//when first player takes his turn box doesnt move, but when the next player (and the next and so on) click the button, they see the synced positions
	
	playerTurn ++; //next players turn once rolled (will be changed)
	if (playerTurn >= players.length){
		playerTurn = 0;
	}
	temp = false;
	sim.scene.remove(rollDiceBox);
	updateFirebase();
	
});

startBox.addEventListener('cursordown', function(){

	console.log("game start");
	
	//loop through all players in game
	
	for (var i = 0; i < players.length; i++){
		playerPos[i] = 0;
		playerMoney[i] = 1500;
	}
	
	
	playerTurn = 0;
	gameStart = true;
	updateFirebase();
	
	//spawn player icons
	//tell player one to roll
	
	
	
});



</script>
</html>