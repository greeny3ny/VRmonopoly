<!DOCTYPE html>
<html>

<head>
<script src="https://aframe.io/releases/0.3.0/aframe.min.js"></script>
<!--<script src="https://cdn.rawgit.com/AltspaceVR/AltspaceSDK/v2.0.2/dist/altspace.min.js"></script>-->
<script src="../../dist/altspace.js"></script>
<script src="https://sdk.altvr.com/libs/altspace.js/2.4.0/altspace.min.js"></script>
<script src="js/three.js"></script>

<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyAPChB8eI_3xS0Sm8UW1IWcyR-_aE5YJyo",
    authDomain: "greeny-masterdatabase-altspace.firebaseapp.com",
    databaseURL: "https://greeny-masterdatabase-altspace.firebaseio.com",
    projectId: "greeny-masterdatabase-altspace",
    storageBucket: "greeny-masterdatabase-altspace.appspot.com",
    messagingSenderId: "667469072790"
  };
  firebase.initializeApp(config);
</script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyCvKQCyURJiH13dXDl_f6kB_deZ67QmbgQ",
    authDomain: "vrmonopoly.firebaseapp.com",
    databaseURL: "https://vrmonopoly.firebaseio.com",
    projectId: "vrmonopoly",
    storageBucket: "vrmonopoly.appspot.com",
    messagingSenderId: "831868478183"
  };
  firebase.initializeApp(config);
</script>
</head>

<body>

<!-- set up the scene -->
<a-scene altspace="fullspace: true" sync-system="author: greeny3ny; app: monopoly">
 
    <!-- add a view camera (2d only) -->
    <!--<a-text value="Hello, World!"></a-text>-->

    <a-assets>
		<img id="board" src="https://cdn.rawgit.com/greeny3ny/VRmonopoly/77c933e2/ALTOPOLY.png"/>
  	</a-assets>

	<a-entity position='4 8 -6' rotation='0 0 0' n-text='text: Craigs Monopoly! ;'></a-entity>
	<a-entity id="players" position='4 6 -6' rotation='0 0 0' n-text='text: Players :  ;' ></a-entity>

    <a-entity geometry="primitive: box" material="shader: flat; src: #board" position = '0 0 0' scale="20 0 20"></a-entity>
	
	<a-box id="tile0" collision="box_id:0;"n-mesh-collider="type:hologram" color="white" position="-8.75, 1, 8.75" rotation="0 0 0" scale="3 3 3" opacity="0.5"  altspace-cursor-collider="enabled: false"></a-box> <!-- home collider-->
	<!--<a-box depth="100" height="0.1" width="100" position='0 360 0'><a-box>
--> 
</a-scene>
 
</body>

<script>
console.log("Version 0.0.1");

var fbMasterRef = new Firebase("https://greeny-masterdatabase-altspace.firebaseio.com/");
var fbGameRef = new Firebase("https://vrmonopoly.firebaseio.com/");

var username;
var userID;
var moderator;
var displayname;

var loaded = false;

var players;

//update info in master database
altspace.getUser().then(function(userInfo) {
	var dataRequest = (THREE.FileLoader ? new THREE.FileLoader() : new THREE.XHRLoader());
	dataRequest.setWithCredentials(true);
	dataRequest.load('https://account.altvr.com/api/v1/users/' + userInfo.userId, onLoaded, undefined, undefined);
	function onLoaded(obj) {
		console.log('JSON thing:');
		console.log(JSON.parse(obj));
		username = JSON.parse(obj).users[0].username;
		userID = JSON.parse(obj).users[0].user_id;
		moderator = JSON.parse(obj).users[0].admin;
		displayname = JSON.parse(obj).users[0].display_name;

		console.log(username + " " + userID + " " + moderator + " " + displayname);

		
		
		fbMasterRef.child("users").once('value', function (snapshot) {
			console.log('Snapshot function worked!');
			console.log(snapshot.child(username).child('Username').val());

			var usernameSnapshot = snapshot.child(username).child('Username').val();

			if (snapshot.exists() && usernameSnapshot == username) {
				console.log('Snapshot exists!');

			} else if (snapshot.exists() && usernameSnapshot != username && usernameSnapshot != null) {
				console.log('Snapshot exists, but user has changed their username.');
				fbMasterRef.child("users").child(username).child('Username').update(username);

			} else {
				console.log('Snapshot does not exist; creating one...');
				console.log('Snapshot will be: ' + username + ', ' + userID + ', ' + moderator + '.');
				fbMasterRef.child("users").child(username).set({'Moderator': moderator, 'User ID': userID, 'Username': username, 'Display Name': displayname}, function () {
					console.log('Snapshot created!');
				});
			}

		});

		
		
		altspace.getDocument().then(function (document) { document.position.set(100, 100, 100); document.rotation.set(0, 90, 0);});
		console.log("loaded");
		
		//main();
		
		
	}
}); 

//---------------------------------------------------------------
//---------------------------------------------------------------
//---------------------------------------------------------------
//---------------------------------------------------------------
//---------------------------------------------------------------
//---------------------------------------------------------------

//--- synchronisation
setTimeout(load, 2000);

//add user to database
//add heartbeat to database
//check other heartbeats
//do database stuff re heatbeats

var sim = new altspace.utilities.Simulation(); //simulation

var local_player;
var local_ref; //player reference in array
var heartbeat;
var inSession;
var host;

var joined; //local 

function load(){

	initVars(); //initialise variables

	fbGameRef.child("inSession").on("value", function(snapshot) {
	
		//console.log(snapshot.val());
		inSession = snapshot.val(); //set up insession array
		
	});
	
	//fbGameRef.child("host").on("value", function(snapshot){
	//	host = snapshot.val();
	//});
	
	setTimeout(main,2000);
	
}

function main(){

	local_ref = inSession.length;
	//add player to array
	inSession.push(local_player + " " + heartbeat + " " + joined);
	//inSession = ["---"]; 
		
	console.log("main");
	
	setTimeout(updateFirebase, 2000); //waits so that above code can load
	setInterval(tick, 1000);
	//setInterval(checkHeartbeats, 5000); //checks heartbeats every 5 seconds
	

}

//initialise variables
function initVars(){
	local_player = displayname;
	heartbeat = 0;
	inSession = ["---"];
	host = false;
	joined = false;
	
	players = ["---"];
}

//update database
function updateFirebase(){
	fbGameRef.update({
		inSession: inSession,
		players: players
	});
	//console.log("database updated!");
}

function readFirebaseUsers(){

	fbGameRef.child("inSession").on("value", function(snapshot) {
		inSession = snapshot.val();
	});

}

function readFirebasePlayers(){

	fbGameRef.child("players").on("value", function(snapshot){
		players = snapshot.val();
	});

}

function tick(){

	heartbeat ++;
	inSession[local_ref] = local_player + " " + heartbeat + " " + joined;
	
	//if (host == true){
	updateFirebase();
	//}
	readFirebasePlayers();
	readFirebaseUsers();
	
	document.querySelector('#players').setAttribute('n-text','text: Players : ' + inSession);

}

function checkHeartbeats(){

 var temp1 = inSession;
 
 setTimeout(function temp(){
 
	var temp2 = inSession;
	var activeCount = 0;
	var activePos = [];
	
	console.log(temp1 + " | " + temp2);
	
	for (var i = 0; i<temp1.length; i++){
	
		if (temp1[i] != temp2[i]){
		
			activePos[activeCount] = i;
			activeCount ++;
			
		}
	
	}
	console.log(activeCount + " players active at : " + activePos);
	var newPos = 0;
	for (var i = 0; i < activePos.length; i++){
		inSession[newPos] = inSession[activePos[i]];
		if (activePos[i] == local_ref){
			//console.log("this is you");
			local_ref = newPos;
		}
		
		if (local_ref == 0){
			host = true;
		} else { host = false; }
		//local_ref = newPos; //might break stuff
		newPos ++;
	}
	//remove rest of array
	for (var j = inSession.length; j > activeCount; j--){
		inSession.pop();
	}
	
 
 }, 4000);
 
}


//base collision aframe component code
AFRAME.registerComponent('collision',
                         {
  schema:  //does stuff
  { 
    jointCubeSize: {
      type: 'float',
      default: 0.275
    },
	box_id:
	{
		type: 'int'
	}
  },
  init: function ()
  {
    var self = this;
    var object = self.el.object3D;
	
    object.addBehavior(new altspace.utilities.behaviors.JointCollisionEvents
                       ({
      joints: [['Head', 'Center', 0]], jointCubeSize: self.data.jointCubeSize
    }));
	
	//joints enter
    object.addEventListener('jointcollisionenter', handleJoin);		
    function handleJoin(event)
    {
		console.log(self.data.box_id);
    }// end function handle join
	
	//joint collision leave
    object.addEventListener('jointcollisionleave', handleLeave);
    function handleLeave(event)
    {
		
    }//end function handle leave
  }
}); //end base collision
 
var redMat = new THREE.MeshBasicMaterial( { color: 0xff0000 } );
var pinkMat = new THREE.MeshBasicMaterial( { color: 0xff00ff } );
var boxGeo = new THREE.BoxGeometry(1, 1, 1);
var joinBox = new THREE.Mesh(boxGeo, redMat); 
var startBox = new THREE.Mesh(boxGeo, pinkMat); 

var playerIcons = [];

var counter = 0;

joinBox.position.set(0, 2, 0);
startBox.position.set(0,2,1);
sim.scene.add(joinBox);
sim.scene.add(startBox);

joinBox.addEventListener('cursordown', function(){

	//first person to click join button becomes host
	//host is the only one that removes from database, hopefully works by avoiding conflicts
	if (counter == 0){
		host = true;
		setInterval(checkHeartbeats, 5000);
		console.log("you are the host");
	}

	console.log("player joined game");
	players[counter] = local_player + " " + 0
	counter ++;
	joined = true;

});

startBox.addEventListener('cursordown', function(){

	console.log("game start");
	
	for (var i = 0; i < players.length; i++){
		playerIcons[i] = new THREE.Mesh(boxGeo, pinkMat);
		playerIcons[i].position.set(0, 0, 2*i);
		sim.scene.add(playerIcons[i]);
	}
	
	//spawn player icons
	//tell player one to roll

});

</script>
</html>